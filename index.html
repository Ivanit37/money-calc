<!DOCTYPE html>
<html lang="zh-HK" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†è³¬å·¥å…·</title>
    
    <!-- PWA / Mobile Web App Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="åˆ†è³¬å·¥å…·">

    <!-- Icons: æŒ‡å‘åŒç›®éŒ„ä¸‹çš„åœ–ç‰‡æª”æ¡ˆï¼Œå·²æ›´æ–°ç‚º PNG æ ¼å¼ -->
    <!-- è«‹ç¢ºä¿ moneycalc.png èˆ‡æ­¤ html æª”æ¡ˆä½æ–¼åŒä¸€è³‡æ–™å¤¾ -->
    <link rel="icon" type="image/png" href="moneycalc.png">
    <link rel="apple-touch-icon" href="moneycalc.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#111111',
                            surface: '#1c1c1c',
                            input: '#2a2a2a',
                            border: '#333333',
                            text: '#e5e5e5',
                            subtext: '#a3a3a3'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #404040; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #525252; }

        .card { 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            padding: 1.5rem; 
            margin-bottom: 1rem; 
            transition: all 0.3s ease; 
        }
        .btn { transition: all 0.2s; user-select: none; }
        .btn:active { transform: scale(0.96); }
        
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .dark #toast {
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .tab-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .dark .tab-inactive { background-color: #2a2a2a; color: #a3a3a3; border-color: #333333; }
        
        .payer-tab-active { background-color: #10b981; color: white; border-color: #10b981; } 
        .payer-tab-inactive { background-color: white; color: #6b7280; border-color: #e5e7eb; }
        .dark .payer-tab-inactive { background-color: #2a2a2a; color: #a3a3a3; border-color: #333333; }
    </style>
</head>
<body id="main-body" class="p-4 max-w-md mx-auto min-h-screen flex flex-col transition-colors duration-300 bg-[#f3f4f6] dark:bg-dark-bg text-gray-900 dark:text-dark-text justify-center">

    <!-- Fixed Header & Controls (é€™ä¸€æ¬„ç¾åœ¨å›ºå®šåœ¨é ‚éƒ¨) -->
    <div id="app-header" class="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-md z-50 p-4 pt-6 pb-4 bg-[#f3f4f6] dark:bg-dark-bg shadow-md">
        <div class="flex justify-between items-start gap-4">
            <!-- Title Section -->
            <div class="flex-1 min-w-0"> 
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white leading-tight truncate" data-i18n="appTitle">ğŸ’° åˆ†è³¬å·¥å…·</h1>
                <p class="text-gray-500 dark:text-gray-400 text-xs mt-1 truncate" data-i18n="appSubtitle">è¼¸å…¥äººå â†’ æ–°å¢æ¶ˆè²» â†’ è‡ªå‹•çµç®—</p>
            </div>
            
            <!-- Controls Section -->
            <div class="flex gap-2 items-center flex-shrink-0">
                <!-- Language Select -->
                <select id="lang-select" onchange="changeLanguage(this.value)" class="bg-gray-200 dark:bg-[#333] text-gray-600 dark:text-gray-300 text-xs rounded-lg px-2 py-1.5 border border-transparent dark:border-[#444] outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                    <option value="hk">ğŸ‡­ğŸ‡° HK</option>
                    <option value="tw">ğŸ‡¹ğŸ‡¼ TW</option>
                    <option value="en">ğŸ‡¬ğŸ‡§ EN</option>
                </select>

                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-1.5 rounded-full bg-gray-200 dark:bg-[#333] text-gray-600 dark:text-yellow-400 hover:bg-gray-300 dark:hover:bg-[#444] transition-colors border border-transparent dark:border-[#444]" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">
                    <svg id="icon-sun" class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="icon-moon" class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Spacer div to push content down (ç´„ 5.5rem / 88px). Hidden by default for centering. -->
    <div id="header-spacer" class="h-[5.5rem] hidden"></div>

    <!-- Notification Toast -->
    <div id="toast">æç¤ºè¨Šæ¯</div>

    <!-- Step 1: Add Users -->
    <div id="step-users" class="card border-l-4 border-blue-500 bg-white dark:bg-dark-surface shadow-sm">
        <div class="flex justify-between items-center mb-3 border-b border-gray-100 dark:border-dark-border pb-2">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100" data-i18n="step1Title">1. å¥½å‹åå–®</h2>
            <span class="text-xs text-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:text-blue-300 px-2 py-1 rounded" data-i18n="step1Badge">ç¬¬ä¸€æ­¥</span>
        </div>
        
        <div class="flex gap-2 mb-4">
            <input type="text" id="new-user-name" data-i18n-placeholder="namePlaceholder" placeholder="è¼¸å…¥åå­— (å¦‚: å°æ˜)" 
                   class="flex-1 border-2 border-gray-200 dark:border-dark-border bg-white dark:bg-dark-input text-gray-900 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 dark:focus:border-blue-500 transition-colors placeholder-gray-400 dark:placeholder-gray-500"
                   onkeypress="handleEnter(event, addUser)">
            <button onclick="addUser()" class="btn bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 flex-shrink-0" data-i18n="btnAdd">
                ï¼‹æ–°å¢
            </button>
        </div>
        
        <div id="user-list" class="flex flex-wrap gap-2 min-h-[40px]">
            <span class="text-gray-400 dark:text-gray-500 text-sm py-2 italic w-full text-center" id="empty-users-msg" data-i18n="emptyUsers">ç›®å‰æ²’æœ‰å¥½å‹ï¼Œè«‹è¼¸å…¥åå­—</span>
        </div>
    </div>

    <!-- Action Buttons Container (Step 1: In flow for centering; Step 2/3: Fixed at bottom) -->
    <div id="action-buttons-container" class="space-y-3 mt-4 mb-6 w-full">
        <button id="lock-users-btn" onclick="lockUsers()" class="btn w-full bg-gray-800 dark:bg-[#333] text-white dark:text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-900 dark:hover:bg-[#444] border border-transparent dark:border-[#444]" data-i18n="btnLock">
            é–‹å§‹è¨˜å¸³ (é–å®šåå–®)
        </button>

        <!-- Reset Confirmation Block: Hidden by default -->
        <div id="reset-confirmation-block" class="hidden space-x-2">
            <button id="cancel-reset-btn" onclick="toggleResetConfirmation(false)" class="btn flex-1 bg-gray-200 dark:bg-[#444] text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 py-3 rounded-xl font-medium text-sm hover:bg-gray-300 dark:hover:bg-[#555]">
                å–æ¶ˆ
            </button>
            <button id="confirm-reset-btn" onclick="performReset()" class="btn flex-1 bg-red-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-red-700">
                ç¢ºèªæ¸…é™¤ï¼
            </button>
        </div>

        <!-- Original Reset Button: Hidden until locked. Now triggers confirmation UI. -->
        <button id="reset-btn" onclick="toggleResetConfirmation(true)" class="hidden btn w-full bg-white dark:bg-[#252525] text-red-500 dark:text-red-400 border border-red-200 dark:border-red-900/30 py-3 rounded-xl font-medium text-sm hover:bg-red-50 dark:hover:bg-[#333] shadow-sm" data-i18n="btnReset">
            ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ä¾†
        </button>
    </div>

    <!-- Step 2: Add Expenses -->
    <div id="step-expenses" class="card hidden border-l-4 border-green-500 bg-white dark:bg-dark-surface shadow-sm">
        <div class="flex justify-between items-center mb-3 border-b border-gray-100 dark:border-dark-border pb-2">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100" data-i18n="step2Title">2. æ–°å¢æ¶ˆè²»</h2>
            <span class="text-xs text-green-600 bg-green-50 dark:bg-green-900/20 dark:text-green-300 px-2 py-1 rounded" data-i18n="step2Badge">è¨˜å¸³ä¸­</span>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-dark-subtext mb-1" data-i18n="labelItem">æ¶ˆè²»é …ç›®</label>
                <input type="text" id="item-desc" data-i18n-placeholder="itemPlaceholder" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€å”±æ­Œ" class="w-full border-2 border-gray-200 dark:border-dark-border bg-white dark:bg-dark-input text-gray-900 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:border-green-500 dark:focus:border-green-500 placeholder-gray-400 dark:placeholder-gray-500">
            </div>

            <!-- PAYER SECTION -->
            <div class="border-t border-gray-100 dark:border-dark-border pt-3">
                 <label class="block text-sm font-medium text-gray-700 dark:text-dark-subtext mb-2" data-i18n="labelPayer">èª°å…ˆä»˜éŒ¢ï¼Ÿ</label>
                 
                 <!-- Payer Mode Tabs -->
                 <div class="flex rounded-lg overflow-hidden border border-gray-200 dark:border-dark-border text-sm font-bold mb-2">
                    <button id="tab-payer-single" onclick="setPayerMode('single')" class="flex-1 py-1.5 text-center transition-colors payer-tab-active" data-i18n="tabSinglePayer">
                        å–®äººå…ˆä»˜
                    </button>
                    <button id="tab-payer-multi" onclick="setPayerMode('multi')" class="flex-1 py-1.5 text-center transition-colors payer-tab-inactive" data-i18n="tabMultiPayer">
                        å¤šäººå…ˆä»˜
                    </button>
                </div>

                <!-- Single Payer Select -->
                <div id="payer-section-single" class="relative">
                    <select id="payer-select" class="w-full border-2 border-gray-200 dark:border-dark-border bg-white dark:bg-dark-input text-gray-900 dark:text-white rounded-lg px-3 py-2 appearance-none focus:outline-none focus:border-green-500 dark:focus:border-green-500">
                        <!-- Options populated by JS -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <!-- Multi Payer Inputs -->
                <div id="payer-section-multi" class="hidden bg-green-50 dark:bg-[#1a2e25] p-3 rounded-lg border border-green-100 dark:border-[#2d4a3e]">
                    <label class="block text-sm font-medium text-green-800 dark:text-green-300 mb-2" data-i18n="labelMultiInput">è¼¸å…¥æ¯å€‹äººä»˜çš„é‡‘é¡ï¼š</label>
                    <div id="multi-payer-inputs" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                        <!-- Inputs populated by JS -->
                    </div>
                    <div class="mt-2 text-right text-xs text-green-600 dark:text-green-400" data-i18n="hintMultiAuto">
                        ç³»çµ±æœƒè‡ªå‹•åŠ ç¸½ç‚ºç¸½é‡‘é¡
                    </div>
                </div>
            </div>

            <!-- AMOUNT DISPLAY (Calculated or Input) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-dark-subtext mb-1" data-i18n="labelAmount">ç¸½é‡‘é¡</label>
                <input type="number" id="item-amount" placeholder="0.00" step="0.01" class="w-full border-2 border-gray-200 dark:border-dark-border bg-white dark:bg-dark-input text-gray-800 dark:text-white rounded-lg px-3 py-2 focus:outline-none focus:border-green-500 dark:focus:border-green-500 font-bold text-xl placeholder-gray-400 dark:placeholder-gray-500" inputmode="decimal">
                <p id="amount-hint" class="text-xs text-gray-400 dark:text-gray-500 mt-1 hidden" data-i18n="hintAmountLock">å¤šäººä»˜æ¬¾æ¨¡å¼ä¸‹ï¼Œç¸½é‡‘é¡ç”±ä¸Šæ–¹è¼¸å…¥è‡ªå‹•è¨ˆç®—</p>
            </div>

            <!-- SPLIT SECTION -->
            <div class="border-t border-gray-100 dark:border-dark-border pt-3">
                <label class="block text-sm font-medium text-gray-700 dark:text-dark-subtext mb-2" data-i18n="labelSplit">åˆ†æ”¤çµ¦èª°ï¼Ÿ (èª°è©²å‡ºéŒ¢)</label>
                
                <!-- Split Mode Tabs -->
                <div class="flex rounded-lg overflow-hidden border border-gray-200 dark:border-dark-border text-sm font-bold mb-2">
                    <button id="tab-split-equal" onclick="setSplitMode('equal')" class="flex-1 py-1.5 text-center transition-colors tab-active" data-i18n="tabEqual">
                        å‡åˆ† (å¹³åˆ†éŒ¢)
                    </button>
                    <button id="tab-split-custom" onclick="setSplitMode('custom')" class="flex-1 py-1.5 text-center transition-colors tab-inactive" data-i18n="tabCustom">
                        å€‹åˆ¥ (å„è‡ªä»˜)
                    </button>
                </div>

                <!-- Mode: Equal Split Checkboxes -->
                <div id="split-section-equal" class="bg-gray-50 dark:bg-[#252525] p-3 rounded-lg border border-gray-100 dark:border-dark-border">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="labelSelectPeople">é¸æ“‡åˆ†æ”¤äºº</label>
                        <button onclick="toggleAllChecks()" class="text-xs text-blue-500 dark:text-blue-400 font-medium" data-i18n="btnAllNone">å…¨é¸/å–æ¶ˆ</button>
                    </div>
                    <div id="split-checkboxes" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                        <!-- Checkboxes populated by JS -->
                    </div>
                </div>

                <!-- Mode: Custom Amount Inputs -->
                <div id="split-section-custom" class="hidden bg-blue-50 dark:bg-[#1e2330] p-3 rounded-lg border border-blue-100 dark:border-[#2d3a5e]">
                    <label class="block text-sm font-medium text-blue-800 dark:text-blue-300 mb-2" data-i18n="labelCustomInput">è¼¸å…¥æ¯å€‹äººè©²å‡ºçš„é‡‘é¡ï¼š</label>
                    <div id="custom-split-inputs" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                        <!-- Inputs populated by JS -->
                    </div>
                    <div id="custom-split-validation" class="mt-2 text-right text-xs text-blue-600 dark:text-blue-400 font-bold">
                        <!-- Validation message -->
                    </div>
                </div>
            </div>

            <button onclick="addExpense()" class="btn w-full bg-green-500 text-white py-3 rounded-xl font-bold text-lg shadow-lg shadow-green-200 dark:shadow-none hover:bg-green-600 active:shadow-none translate-y-0 mt-2" data-i18n="btnAddExpense">
                ï¼‹ åŠ å…¥é€™ç­†å¸³
            </button>
        </div>

        <!-- Expense History -->
        <div class="mt-6 border-t border-gray-100 dark:border-dark-border pt-4">
            <h3 class="font-bold text-gray-700 dark:text-gray-300 text-sm mb-3 flex items-center">
                <span class="mr-2">ğŸ“‹</span> <span data-i18n="headerHistory">å·²è¨˜éŒ„é …ç›®</span> 
                <span id="total-amount-display" class="ml-auto text-xs font-normal text-gray-500 dark:text-gray-400">ç¸½é‡‘é¡: $0.00</span>
            </h3>
            <ul id="expense-list" class="space-y-3 text-sm text-gray-600 dark:text-gray-300 max-h-60 overflow-y-auto pr-1">
                <li class="text-center text-gray-400 dark:text-gray-500 italic py-4 bg-gray-50 dark:bg-[#252525] rounded-lg border border-dashed border-gray-300 dark:border-dark-border" data-i18n="emptyHistory">
                    ç›®å‰é‚„æ²’æœ‰æ¶ˆè²»è¨˜éŒ„
                </li>
            </ul>
        </div>
    </div>

    <!-- Step 3: Result -->
    <div id="step-result" class="card hidden bg-gradient-to-br from-indigo-50 to-white dark:from-dark-surface dark:to-dark-surface border border-indigo-100 dark:border-dark-border">
        <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-3 border-b border-indigo-100 dark:border-dark-border pb-2" data-i18n="headerResult">ğŸ“Š æœ€çµ‚çµç®—å»ºè­°</h2>
        <div id="result-list" class="space-y-3">
            <!-- Results here -->
        </div>
        
        <!-- Share Button -->
        <button onclick="shareResult()" class="btn w-full bg-purple-600 text-white py-3 rounded-xl font-bold text-lg mt-4 shadow-lg shadow-purple-200 dark:shadow-none hover:bg-purple-700 flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
            <span data-i18n="btnShare">åˆ†äº« / è¤‡è£½çµæœ</span>
        </button>
    </div>

    <!-- Footer Spacer only shown in scroll mode to prevent fixed buttons blocking content -->
    <div class="h-24 hidden" id="footer-spacer"></div>

    <script>
        // --- Translations ---
        const translations = {
            hk: {
                appTitle: "ğŸ’° åˆ†è³¬å·¥å…·",
                appSubtitle: "è¼¸å…¥äººå â†’ æ–°å¢æ¶ˆè²» â†’ è‡ªå‹•çµç®—",
                step1Title: "1. å¥½å‹åå–®",
                step1Badge: "ç¬¬ä¸€æ­¥",
                namePlaceholder: "è¼¸å…¥åå­— (å¦‚: å°æ˜)",
                btnAdd: "ï¼‹æ–°å¢",
                emptyUsers: "ç›®å‰æ²’æœ‰å¥½å‹ï¼Œè«‹è¼¸å…¥åå­—",
                step2Title: "2. æ–°å¢æ¶ˆè²»",
                step2Badge: "è¨˜å¸³ä¸­",
                labelItem: "æ¶ˆè²»é …ç›®",
                itemPlaceholder: "ä¾‹å¦‚ï¼šåˆé¤ã€å”±K",
                labelPayer: "é‚Šå€‹ç•€éŒ¢ï¼Ÿ",
                tabSinglePayer: "å–®äººç•€",
                tabMultiPayer: "å¤šäººå¤¾",
                labelMultiInput: "è¼¸å…¥æ¯å€‹äººä»˜å˜…é‡‘é¡ï¼š",
                hintMultiAuto: "ç³»çµ±æœƒè‡ªå‹•åŠ ç¸½ç‚ºç¸½é‡‘é¡",
                labelAmount: "ç¸½é‡‘é¡",
                hintAmountLock: "å¤šäººä»˜æ¬¾æ¨¡å¼ä¸‹ï¼Œç¸½é‡‘é¡ç”±ä¸Šæ–¹è¼¸å…¥è‡ªå‹•è¨ˆç®—",
                labelSplit: "åˆ†ç•€é‚Šå€‹ï¼Ÿ (é‚Šå€‹è¦ç•€éŒ¢)",
                tabEqual: "å‡åˆ† (å¹³åˆ†)",
                tabCustom: "å€‹åˆ¥ (å„è‡ªç•€)",
                labelSelectPeople: "é¸æ“‡åˆ†æ”¤äºº",
                btnAllNone: "å…¨é¸/å–æ¶ˆ",
                labelCustomInput: "è¼¸å…¥æ¯å€‹äººè©²ç•€å˜…é‡‘é¡ï¼š",
                btnAddExpense: "ï¼‹ åŠ å…¥é€™ç­†æ•¸",
                headerHistory: "å·²è¨˜éŒ„é …ç›®",
                emptyHistory: "ç›®å‰ä»²æœªæœ‰æ¶ˆè²»è¨˜éŒ„",
                headerResult: "ğŸ“Š æœ€çµ‚çµç®—å»ºè­°",
                btnShare: "åˆ†äº« / è¤‡è£½çµæœ",
                btnLock: "é–‹å§‹è¨˜å¸³ (é–å®šåå–®)",
                btnReset: "ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ä¾†",
                msgMatch: "âœ… é‡‘é¡å»åˆ",
                msgMismatch: "âŒ é‡‘é¡ä¸ç¬¦ (é‚„å·® ${diff})",
                toastAddName: "è«‹è¼¸å…¥åå­—ï¼",
                toastNameExists: "é€™å€‹åå­—å·²ç¶“åœ¨åå–®å…§å›‰ï¼",
                toastMinUsers: "è‡³å°‘éœ€è¦å…©å€‹äººæ‰èƒ½åˆ†å¸³å–”ï¼",
                toastZeroAmount: "ç¸½é‡‘é¡ä¸èƒ½ç‚º 0ï¼",
                toastPayMismatch: "ä»˜æ¬¾é‡‘é¡èˆ‡ç¸½é‡‘é¡ä¸ç¬¦ï¼",
                toastNoSplitUser: "è‡³å°‘è¦é¸ä¸€å€‹äººåˆ†æ”¤ï¼",
                toastSplitMismatch: "åˆ†æ”¤é‡‘é¡ä¸ç¬¦ (å·® ${diff})",
                toastAdded: "å·²åŠ å…¥ä¸€ç­†ç´€éŒ„ï¼",
                toastNoHistory: "é‚„æ²’æœ‰æ¶ˆè²»è¨˜éŒ„å–”ï¼",
                toastCopied: "å·²è¤‡è£½ï¼å¿«è²¼çµ¦æœ‹å‹å§",
                toastResetConfirm: "ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ä¾†å—ï¼Ÿ",
                toastResetDone: "å·²é‡ç½®è³‡æ–™",
                shareTitle: "ã€æ¶ˆè²»æ˜ç´°ã€‘",
                sharePaidBy: "ç•€", // e.g. ivan ç•€
                sharePaidByMulti: "ç•€", // e.g. ivan & peter ç•€
                shareResultTitle: "ã€æœ€çµ‚çµç®—ã€‘",
                shareNoDebt: "ğŸ‰ å¸³ç›®å·²å¹³ï¼Œä¸ç”¨ä»˜éŒ¢ï¼",
                shareArrow: "â†’",
                shareGive: "ç•€", // peter ç•€ ivan
                totalLabel: "ç¸½é‡‘é¡",
                paidTag: "ä»˜",
                splitTag: "åˆ†",
                payerSuffix: "å…ˆä»˜",
                splitSuffix: "å¹³åˆ†",
                customSplitPrefix: "å€‹åˆ¥åˆ†æ”¤: ",
                equalSplitText: "${count} äººå¹³åˆ†",
                payLabel: "PAY",
                noDebtMsg: "ğŸ‰ å¤ªæ£’äº†ï¼æ²’æœ‰äººéœ€è¦ä»˜éŒ¢ï¼ˆå¸³ç›®å·²å¹³ï¼‰"
            },
            tw: {
                appTitle: "ğŸ’° åˆ†å¸³å·¥å…·",
                appSubtitle: "è¼¸å…¥äººå â†’ æ–°å¢æ¶ˆè²» â†’ è‡ªå‹•çµç®—",
                step1Title: "1. å¥½å‹åå–®",
                step1Badge: "ç¬¬ä¸€æ­¥",
                namePlaceholder: "è¼¸å…¥åå­— (å¦‚: å°æ˜)",
                btnAdd: "ï¼‹æ–°å¢",
                emptyUsers: "ç›®å‰æ²’æœ‰å¥½å‹ï¼Œè«‹è¼¸å…¥åå­—",
                step2Title: "2. æ–°å¢æ¶ˆè²»",
                step2Badge: "è¨˜å¸³ä¸­",
                labelItem: "æ¶ˆè²»é …ç›®",
                itemPlaceholder: "ä¾‹å¦‚ï¼šåˆé¤ã€å”±æ­Œ",
                labelPayer: "èª°å…ˆä»˜éŒ¢ï¼Ÿ",
                tabSinglePayer: "å–®äººå…ˆä»˜",
                tabMultiPayer: "å¤šäººå…ˆä»˜",
                labelMultiInput: "è¼¸å…¥æ¯å€‹äººä»˜çš„é‡‘é¡ï¼š",
                hintMultiAuto: "ç³»çµ±æœƒè‡ªå‹•åŠ ç¸½ç‚ºç¸½é‡‘é¡",
                labelAmount: "ç¸½é‡‘é¡",
                hintAmountLock: "å¤šäººä»˜æ¬¾æ¨¡å¼ä¸‹ï¼Œç¸½é‡‘é¡ç”±ä¸Šæ–¹è¼¸å…¥è‡ªå‹•è¨ˆç®—",
                labelSplit: "åˆ†æ”¤çµ¦èª°ï¼Ÿ (èª°è©²å‡ºéŒ¢)",
                tabEqual: "å‡åˆ† (å¹³åˆ†éŒ¢)",
                tabCustom: "å€‹åˆ¥ (å„è‡ªä»˜)",
                labelSelectPeople: "é¸æ“‡åˆ†æ”¤äºº",
                btnAllNone: "å…¨é¸/å–æ¶ˆ",
                labelCustomInput: "è¼¸å…¥æ¯å€‹äººè©²å‡ºçš„é‡‘é¡ï¼š",
                btnAddExpense: "ï¼‹ åŠ å…¥é€™ç­†å¸³",
                headerHistory: "å·²è¨˜éŒ„é …ç›®",
                emptyHistory: "ç›®å‰é‚„æ²’æœ‰æ¶ˆè²»è¨˜éŒ„",
                headerResult: "ğŸ“Š æœ€çµ‚çµç®—å»ºè­°",
                btnShare: "åˆ†äº« / è¤‡è£½çµæœ",
                btnLock: "é–‹å§‹è¨˜å¸³ (é–å®šåå–®)",
                btnReset: "ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ä¾†",
                msgMatch: "âœ… é‡‘é¡å»åˆ",
                msgMismatch: "âŒ é‡‘é¡ä¸ç¬¦ (é‚„å·® ${diff})",
                toastAddName: "è«‹è¼¸å…¥åå­—ï¼",
                toastNameExists: "é€™å€‹åå­—å·²ç¶“åœ¨åå–®å…§å›‰ï¼",
                toastMinUsers: "è‡³å°‘éœ€è¦å…©å€‹äººæ‰èƒ½åˆ†å¸³å–”ï¼",
                toastZeroAmount: "ç¸½é‡‘é¡ä¸èƒ½ç‚º 0ï¼",
                toastPayMismatch: "ä»˜æ¬¾é‡‘é¡èˆ‡ç¸½é‡‘é¡ä¸ç¬¦ï¼",
                toastNoSplitUser: "è‡³å°‘è¦é¸ä¸€å€‹äººåˆ†æ”¤ï¼",
                toastSplitMismatch: "åˆ†æ”¤é‡‘é¡ä¸ç¬¦ (å·® ${diff})",
                toastAdded: "å·²åŠ å…¥ä¸€ç­†ç´€éŒ„ï¼",
                toastNoHistory: "é‚„æ²’æœ‰æ¶ˆè²»è¨˜éŒ„å–”ï¼",
                toastCopied: "å·²è¤‡è£½ï¼å¿«è²¼çµ¦æœ‹å‹å§",
                toastResetConfirm: "ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ä¾†å—ï¼Ÿ",
                toastResetDone: "å·²é‡ç½®è³‡æ–™",
                shareTitle: "ã€æ¶ˆè²»æ˜ç´°ã€‘",
                sharePaidBy: "å…ˆä»˜",
                sharePaidByMulti: "å…ˆä»˜",
                shareResultTitle: "ã€æœ€çµ‚çµç®—ã€‘",
                shareNoDebt: "ğŸ‰ å¸³ç›®å·²å¹³ï¼Œä¸ç”¨ä»˜éŒ¢ï¼",
                shareArrow: "â†’",
                shareGive: "çµ¦",
                totalLabel: "ç¸½é‡‘é¡",
                paidTag: "ä»˜",
                splitTag: "åˆ†",
                payerSuffix: "å…ˆä»˜",
                splitSuffix: "å¹³åˆ†",
                customSplitPrefix: "å€‹åˆ¥åˆ†æ”¤: ",
                equalSplitText: "${count} äººå¹³åˆ†",
                payLabel: "PAY",
                noDebtMsg: "ğŸ‰ å¤ªæ£’äº†ï¼æ²’æœ‰äººéœ€è¦ä»˜éŒ¢ï¼ˆå¸³ç›®å·²å¹³ï¼‰"
            },
            en: {
                appTitle: "ğŸ’° Bill Splitter",
                appSubtitle: "Add Users â†’ Add Expenses â†’ Auto Split",
                step1Title: "1. Friends",
                step1Badge: "Step 1",
                namePlaceholder: "Enter name (e.g. John)",
                btnAdd: "+ Add",
                emptyUsers: "No friends yet, please add names.",
                step2Title: "2. Add Expense",
                step2Badge: "Active",
                labelItem: "Item Name",
                itemPlaceholder: "e.g. Lunch, Karaoke",
                labelPayer: "Who Paid?",
                tabSinglePayer: "Single Payer",
                tabMultiPayer: "Multi Payer",
                labelMultiInput: "Enter amount paid by each:",
                hintMultiAuto: "Total calculated automatically",
                labelAmount: "Total Amount",
                hintAmountLock: "Total is calculated from above inputs",
                labelSplit: "Split with whom?",
                tabEqual: "Equal Split",
                tabCustom: "Custom Split",
                labelSelectPeople: "Select People",
                btnAllNone: "All/None",
                labelCustomInput: "Enter amount owed by each:",
                btnAddExpense: "+ Add Expense",
                headerHistory: "History",
                emptyHistory: "No expenses recorded yet",
                headerResult: "ğŸ“Š Settlement Plan",
                btnShare: "Share / Copy Result",
                btnLock: "Start (Lock Users)",
                btnReset: "ğŸ—‘ï¸ Reset All Data",
                msgMatch: "âœ… Matched",
                msgMismatch: "âŒ Mismatch (Diff: ${diff})",
                toastAddName: "Please enter a name!",
                toastNameExists: "Name already exists!",
                toastMinUsers: "Need at least 2 people!",
                toastZeroAmount: "Amount cannot be 0!",
                toastPayMismatch: "Payment amount mismatch!",
                toastNoSplitUser: "Select at least one person!",
                toastSplitMismatch: "Split amount mismatch (Diff: ${diff})",
                toastAdded: "Expense added!",
                toastNoHistory: "No records yet!",
                toastCopied: "Copied to clipboard!",
                toastResetConfirm: "Are you sure you want to delete all data?",
                toastResetDone: "Data reset.",
                shareTitle: "[Expenses]",
                sharePaidBy: "paid",
                sharePaidByMulti: "paid",
                shareResultTitle: "[Settlement]",
                shareNoDebt: "ğŸ‰ All settled!",
                shareArrow: "â†’",
                shareGive: "pays",
                totalLabel: "Total",
                paidTag: "Paid",
                splitTag: "Split",
                payerSuffix: "paid",
                splitSuffix: "split",
                customSplitPrefix: "Custom: ",
                equalSplitText: "Split by ${count}",
                payLabel: "PAY",
                noDebtMsg: "ğŸ‰ Awesome! No debts found."
            }
        };

        let currentLang = 'hk';

        function changeLanguage(lang) {
            currentLang = lang;
            
            // Update simple text elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Re-render dynamic lists to update their text
            renderUsers(); // Update empty message if needed
            renderExpenses(); // Update history list text
            calculate(); // Update result list text
            validateCustomSplit(); // Update validation message
        }

        // --- Theme Management ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        // --- State Management ---
        let users = [];
        let expenses = [];
        let totalAmount = 0;
        let splitMode = 'equal'; // 'equal' or 'custom'
        let payerMode = 'single'; // 'single' or 'multi'
        let lastTransactions = []; // Store calculated transactions for sharing

        // --- UI Helpers ---
        function showToast(message, type = 'normal') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? '#ef4444' : (document.documentElement.classList.contains('dark') ? '#333' : '#333');
            toast.style.color = (document.documentElement.classList.contains('dark') && type !== 'error') ? '#fff' : '#fff';
            toast.className = 'show';
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }

        function handleEnter(e, callback) {
            if (e.key === 'Enter') callback();
        }

        // --- Confirmation and Reset Logic ---

        /**
         * Toggles the confirmation UI for the reset button.
         * @param {boolean} show If true, shows the confirmation buttons. If false, shows the main reset button.
         */
        function toggleResetConfirmation(show) {
            const resetBtn = document.getElementById('reset-btn');
            const resetConfirmBlock = document.getElementById('reset-confirmation-block');
            
            if (show) {
                resetBtn.classList.add('hidden');
                resetConfirmBlock.classList.remove('hidden');
                resetConfirmBlock.classList.add('flex');
            } else {
                // This is called by the 'Cancel' button or after actual reset
                resetConfirmBlock.classList.add('hidden');
                resetConfirmBlock.classList.remove('flex');
                
                // Only show main reset button if we are in scroll mode (locked users)
                if (!document.getElementById('lock-users-btn').classList.contains('hidden')) {
                    resetBtn.classList.add('hidden'); // Stay hidden in pre-lock mode
                } else {
                    resetBtn.classList.remove('hidden'); // Show in scroll mode
                }
            }
        }

        /**
         * Performs the actual data reset. This replaces the old logic that contained `confirm()`.
         */
        function performReset() {
            users = [];
            expenses = [];
            totalAmount = 0;
            
            const mainBody = document.getElementById('main-body');
            const btnContainer = document.getElementById('action-buttons-container');
            const footerSpacer = document.getElementById('footer-spacer');
            const t = translations[currentLang];

            // 1. Revert UI state to Centered Mode
            mainBody.classList.add('justify-center');
            document.getElementById('header-spacer').classList.add('hidden');

            // 2. Change button container back to Flow position
            btnContainer.classList.remove('fixed', 'bottom-10', 'left-1/2', 'transform', '-translate-x-1/2', 'w-[calc(100%-2rem)]', 'max-w-md', 'z-10');
            btnContainer.classList.add('mt-4', 'mb-6');

            footerSpacer.classList.add('hidden');

            // 3. UI Element Hiding/Showing
            document.getElementById('step-users').classList.remove('opacity-75', 'pointer-events-none', 'grayscale');
            document.getElementById('step-expenses').classList.add('hidden');
            document.getElementById('step-result').classList.add('hidden');
            document.getElementById('lock-users-btn').classList.remove('hidden');
            document.getElementById('reset-btn').classList.add('hidden');
            
            // 4. Clean up state and re-render
            setPayerMode('single');
            setSplitMode('equal');

            renderUsers();
            renderExpenses();
            document.getElementById('result-list').innerHTML = '';
            
            // 5. Hide confirmation UI
            toggleResetConfirmation(false);
            
            showToast(t.toastResetDone);
        }

        // The original resetApp is now just a wrapper for force-reset from internal logic.
        function resetApp(force = false) {
             if (force) {
                 performReset();
             } else {
                 // The actual UI button now calls toggleResetConfirmation(true)
                 // This function is kept for consistency with the old internal logic (like lockUsers check)
                 toggleResetConfirmation(true);
             }
        }


        // --- Mode Switching Logic ---
        function setPayerMode(mode) {
            payerMode = mode;
            const singleBtn = document.getElementById('tab-payer-single');
            const multiBtn = document.getElementById('tab-payer-multi');
            const singleSection = document.getElementById('payer-section-single');
            const multiSection = document.getElementById('payer-section-multi');
            const amountInput = document.getElementById('item-amount');
            const hint = document.getElementById('amount-hint');

            if (mode === 'single') {
                singleBtn.className = 'flex-1 py-1.5 text-center transition-colors payer-tab-active';
                multiBtn.className = 'flex-1 py-1.5 text-center transition-colors payer-tab-inactive';
                singleSection.classList.remove('hidden');
                multiSection.classList.add('hidden');
                
                // Unlock total amount input unless split mode is custom
                if (splitMode !== 'custom') {
                    amountInput.readOnly = false;
                    amountInput.classList.remove('bg-gray-100');
                    amountInput.classList.remove('dark:bg-gray-600'); 
                    amountInput.classList.remove('dark:bg-[#444]'); 
                    hint.classList.add('hidden');
                }
            } else {
                multiBtn.className = 'flex-1 py-1.5 text-center transition-colors payer-tab-active';
                singleBtn.className = 'flex-1 py-1.5 text-center transition-colors payer-tab-inactive';
                multiSection.classList.remove('hidden');
                singleSection.classList.add('hidden');
                
                // In multi payer, total amount is derived
                amountInput.readOnly = true;
                amountInput.classList.add('bg-gray-100');
                amountInput.classList.add('dark:bg-[#444]'); 
                hint.classList.remove('hidden');
                updateTotalFromPayers();
            }
        }

        function setSplitMode(mode) {
            splitMode = mode;
            const equalBtn = document.getElementById('tab-split-equal');
            const customBtn = document.getElementById('tab-split-custom');
            const equalSection = document.getElementById('split-section-equal');
            const customSection = document.getElementById('split-section-custom');
            const amountInput = document.getElementById('item-amount');

            if (mode === 'equal') {
                equalBtn.className = 'flex-1 py-1.5 text-center transition-colors tab-active';
                customBtn.className = 'flex-1 py-1.5 text-center transition-colors tab-inactive';
                equalSection.classList.remove('hidden');
                customSection.classList.add('hidden');
                
                // If payer is single, unlock amount. If payer is multi, amount is locked by payer.
                if (payerMode === 'single') {
                    amountInput.readOnly = false;
                    amountInput.classList.remove('bg-gray-100');
                    amountInput.classList.remove('dark:bg-[#444]');
                }
            } else {
                customBtn.className = 'flex-1 py-1.5 text-center transition-colors tab-active';
                equalBtn.className = 'flex-1 py-1.5 text-center transition-colors tab-inactive';
                customSection.classList.remove('hidden');
                equalSection.classList.add('hidden');
                
                // In custom split, we validate against total, we don't necessarily override it if Payer is Multi
                if (payerMode === 'single') {
                     // If Single Payer + Custom Split, let Custom Split Inputs drive the Total for convenience
                     amountInput.readOnly = true;
                     amountInput.classList.add('bg-gray-100');
                     amountInput.classList.add('dark:bg-[#444]');
                     updateTotalFromSplits();
                }
            }
            validateCustomSplit();
        }

        // --- User Management ---
        function addUser() {
            const input = document.getElementById('new-user-name');
            const name = input.value.trim();
            const t = translations[currentLang];
            
            if (!name) {
                showToast(t.toastAddName, "error");
                return;
            }
            if (users.includes(name)) {
                showToast(t.toastNameExists, "error");
                return;
            }

            users.push(name);
            renderUsers();
            input.value = '';
        }

        function renderUsers() {
            const container = document.getElementById('user-list');
            const t = translations[currentLang];

            if (users.length === 0) {
                container.innerHTML = `<span class="text-gray-400 dark:text-gray-500 text-sm py-2 italic w-full text-center" id="empty-users-msg">${t.emptyUsers}</span>`;
                return;
            }

            container.innerHTML = users.map((u, idx) => 
                `<div class="fade-in bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-medium border border-blue-200 dark:border-blue-800 flex items-center gap-2">
                    ${u}
                    <button onclick="removeUser(${idx})" class="text-blue-400 dark:text-blue-300 hover:text-blue-600 dark:hover:text-blue-100 text-xs font-bold leading-none">âœ•</button>
                </div>`
            ).join('');
        }

        function removeUser(index) {
            users.splice(index, 1);
            renderUsers();
        }

        // --- Transition to Expense Phase ---
        function lockUsers() {
            const t = translations[currentLang];
            
            if (users.length < 2) {
                // If the user presses the button but hasn't entered names, show the prompt
                showToast(t.toastMinUsers, "error");
                
                // *** FORCE RESET if somehow state is inconsistent (as requested by user) ***
                if (users.length === 0 && expenses.length > 0) {
                    showToast("åµæ¸¬åˆ°æ•¸æ“šä¸ä¸€è‡´ï¼Œå¼·åˆ¶é‡ç½®ä¸­...", "error");
                    // Note: Calling performReset() directly here, bypassing the manual reset UI flow.
                    setTimeout(() => performReset(), 1500); 
                    return;
                }
                return;
            }
            
            const mainBody = document.getElementById('main-body');
            const btnContainer = document.getElementById('action-buttons-container');
            const footerSpacer = document.getElementById('footer-spacer');

            // --- Layout Change: Scroll Mode (Top alignment, fixed buttons) ---
            mainBody.classList.remove('justify-center');
            document.getElementById('header-spacer').classList.remove('hidden'); // Show top spacer

            // Change button container to Fixed position (Updated bottom-4 to bottom-10)
            btnContainer.classList.add('fixed', 'bottom-10', 'left-1/2', 'transform', '-translate-x-1/2', 'w-[calc(100%-2rem)]', 'max-w-md', 'z-10');
            btnContainer.classList.remove('mt-4', 'mb-6');

            footerSpacer.classList.remove('hidden');

            document.getElementById('step-users').classList.add('opacity-75', 'pointer-events-none', 'grayscale');
            document.getElementById('lock-users-btn').classList.add('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');
            
            // Hide confirmation block if it was visible
            toggleResetConfirmation(false); 
            
            const expenseStep = document.getElementById('step-expenses');
            expenseStep.classList.remove('hidden');
            expenseStep.classList.add('fade-in');
            
            const resultStep = document.getElementById('step-result');
            resultStep.classList.remove('hidden');
            resultStep.classList.add('fade-in');
            
            // Populate Inputs
            const payerSelect = document.getElementById('payer-select');
            const splitBox = document.getElementById('split-checkboxes');
            const customSplitBox = document.getElementById('custom-split-inputs');
            const multiPayerBox = document.getElementById('multi-payer-inputs');
            
            // 1. Single Payer Dropdown
            payerSelect.innerHTML = users.map(u => `<option value="${u}">${u}</option>`).join('');
            
            // 2. Multi Payer Inputs
            multiPayerBox.innerHTML = users.map(u => `
                <div class="flex items-center space-x-2">
                    <label class="w-16 text-sm text-gray-600 dark:text-dark-subtext truncate text-right">${u}</label>
                    <input type="number" data-user="${u}" placeholder="0.00" step="0.01" oninput="updateTotalFromPayers()" class="multi-payer-input flex-1 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-input text-gray-900 dark:text-white rounded px-2 py-1 text-sm focus:outline-none focus:border-green-500 dark:focus:border-green-500">
                </div>
            `).join('');

            // 3. Equal Split Checkboxes
            splitBox.innerHTML = users.map(u => `
                <label class="flex items-center space-x-2 cursor-pointer bg-white dark:bg-[#252525] p-2 rounded border border-gray-200 dark:border-dark-border hover:bg-gray-50 dark:hover:bg-[#333] transition-colors">
                    <input type="checkbox" class="participant-check w-4 h-4 text-green-600 rounded focus:ring-green-500 dark:focus:ring-offset-[#252525] dark:bg-[#444] dark:border-[#555]" value="${u}" checked>
                    <span class="text-sm select-none text-gray-700 dark:text-gray-200">${u}</span>
                </label>
            `).join('');

            // 4. Custom Split Inputs
            customSplitBox.innerHTML = users.map(u => `
                <div class="flex items-center space-x-2">
                    <label class="w-16 text-sm text-gray-600 dark:text-dark-subtext truncate text-right">${u}</label>
                    <input type="number" data-user="${u}" placeholder="0.00" step="0.01" oninput="handleCustomSplitInput()" class="custom-split-input flex-1 border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-input text-gray-900 dark:text-white rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500 dark:focus:border-blue-500">
                </div>
            `).join('');

            // Scroll to top
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        // --- Logic Updates ---
        function toggleAllChecks() {
            const checkboxes = document.querySelectorAll('.participant-check');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        function updateTotalFromPayers() {
            const inputs = document.querySelectorAll('.multi-payer-input');
            let sum = 0;
            inputs.forEach(input => {
                const val = parseFloat(input.value) || 0;
                sum += val;
            });
            document.getElementById('item-amount').value = sum > 0 ? parseFloat(sum.toFixed(2)) : '';
            validateCustomSplit();
        }

        function updateTotalFromSplits() {
            if (payerMode === 'multi') return; // If Multi-payer, Payer rules the total

            const inputs = document.querySelectorAll('.custom-split-input');
            let sum = 0;
            inputs.forEach(input => {
                const val = parseFloat(input.value) || 0;
                sum += val;
            });
            document.getElementById('item-amount').value = sum > 0 ? parseFloat(sum.toFixed(2)) : '';
        }

        function handleCustomSplitInput() {
            if (payerMode === 'single') {
                updateTotalFromSplits();
            } else {
                validateCustomSplit();
            }
        }

        function validateCustomSplit() {
            if (splitMode !== 'custom') return;
            const t = translations[currentLang];
            
            const total = parseFloat(document.getElementById('item-amount').value) || 0;
            const inputs = document.querySelectorAll('.custom-split-input');
            let currentSum = 0;
            inputs.forEach(input => currentSum += (parseFloat(input.value) || 0));
            
            const msgEl = document.getElementById('custom-split-validation');
            
            if (Math.abs(total - currentSum) < 0.01) {
                msgEl.textContent = t.msgMatch;
                msgEl.className = "mt-2 text-right text-xs text-green-600 dark:text-green-400 font-bold";
            } else {
                const diff = (total - currentSum).toFixed(2);
                msgEl.textContent = t.msgMismatch.replace('${diff}', diff);
                msgEl.className = "mt-2 text-right text-xs text-red-500 dark:text-red-400 font-bold";
            }
        }

        function addExpense() {
            const t = translations[currentLang];
            const desc = document.getElementById('item-desc').value.trim() || 'æœªå‘½åé …ç›®';
            const amount = parseFloat(document.getElementById('item-amount').value);
            
            // 1. Validate Total
            if (!amount || amount <= 0 || isNaN(amount)) {
                showToast(t.toastZeroAmount, "error");
                return;
            }

            // 2. Build Payers Object { name: amountPaid }
            let payers = {};
            if (payerMode === 'single') {
                const payerName = document.getElementById('payer-select').value;
                payers[payerName] = amount;
            } else {
                const inputs = document.querySelectorAll('.multi-payer-input');
                let inputSum = 0;
                inputs.forEach(input => {
                    const val = parseFloat(input.value) || 0;
                    if (val > 0) {
                        payers[input.dataset.user] = val;
                        inputSum += val;
                    }
                });
                if (Math.abs(inputSum - amount) > 0.01) {
                    showToast(t.toastPayMismatch, "error");
                    return;
                }
            }

            // 3. Build Consumers Object { name: amountOwed }
            let consumers = {};
            if (splitMode === 'equal') {
                const checkboxes = document.querySelectorAll('.participant-check:checked');
                const involved = Array.from(checkboxes).map(cb => cb.value);

                if (involved.length === 0) {
                    showToast(t.toastNoSplitUser, "error");
                    return;
                }
                const perPerson = amount / involved.length;
                involved.forEach(u => consumers[u] = perPerson);

            } else {
                const inputs = document.querySelectorAll('.custom-split-input');
                let inputSum = 0;
                inputs.forEach(input => {
                    const val = parseFloat(input.value) || 0;
                    if (val > 0) {
                        consumers[input.dataset.user] = val;
                        inputSum += val;
                    }
                });
                
                if (Math.abs(inputSum - amount) > 0.01) {
                    showToast(t.toastSplitMismatch.replace('${diff}', (amount - inputSum).toFixed(2)), "error");
                    return;
                }
            }

            // Add Record
            expenses.push({ desc, amount, payers, consumers });
            totalAmount += amount;
            
            // Reset UI
            document.getElementById('item-desc').value = '';
            document.getElementById('item-amount').value = '';
            document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
            document.querySelectorAll('.participant-check').forEach(c => c.checked = true);
            document.getElementById('custom-split-validation').textContent = ''; 

            // Reset modes to default for convenience
            setPayerMode('single');
            setSplitMode('equal');

            renderExpenses();
            calculate(); 
            showToast(t.toastAdded);
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const t = translations[currentLang];
            document.getElementById('total-amount-display').innerText = `${t.totalLabel}: $${totalAmount.toFixed(2)}`;

            if (expenses.length === 0) {
                list.innerHTML = `<li class="text-center text-gray-400 dark:text-gray-500 italic py-4 bg-gray-50 dark:bg-[#252525] rounded-lg border border-dashed border-gray-300 dark:border-dark-border">${t.emptyHistory}</li>`;
                return;
            }
            
            list.innerHTML = expenses.map((e, index) => {
                // Format Payers
                const payerNames = Object.keys(e.payers);
                let payerText = "";
                if (payerNames.length === 1) {
                    payerText = `${payerNames[0]} ${t.payerSuffix}`;
                } else {
                    payerText = payerNames.map(n => `${n}($${e.payers[n].toFixed(2)})`).join(', ') + " " + t.payerSuffix;
                }

                // Format Consumers
                const consumerNames = Object.keys(e.consumers);
                let consumerText = "";
                const amounts = Object.values(e.consumers);
                const isEqual = amounts.every(val => Math.abs(val - amounts[0]) < 0.01);

                if (isEqual) {
                     if (consumerNames.length > 3) {
                        consumerText = `${consumerNames.slice(0,2).join(',')}... ` + t.equalSplitText.replace('${count}', consumerNames.length);
                     } else {
                        consumerText = `${consumerNames.join(', ')} ` + t.splitSuffix;
                     }
                } else {
                    consumerText = t.customSplitPrefix + consumerNames.map(n => `${n}($${e.consumers[n].toFixed(2)})`).join(', ');
                }

                return `
                <li class="fade-in bg-white dark:bg-[#1a1a1a] border border-gray-100 dark:border-dark-border p-3 rounded-lg flex justify-between items-center shadow-sm">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="font-bold text-gray-800 dark:text-gray-200 truncate mr-2">${e.desc}</span>
                            <span class="text-green-600 dark:text-green-400 font-bold font-mono">$${e.amount.toFixed(2)}</span>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            <div class="mb-0.5"><span class="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-1 rounded mr-1">${t.paidTag}</span> ${payerText}</div>
                            <div><span class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 px-1 rounded mr-1">${t.splitTag}</span> ${consumerText}</div>
                        </div>
                    </div>
                    <button onclick="removeExpense(${index})" class="ml-3 text-gray-300 dark:text-gray-600 hover:text-red-500 dark:hover:text-red-400 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </li>
            `}).join('');
            
            list.scrollTop = list.scrollHeight;
        }

        function removeExpense(index) {
            totalAmount -= expenses[index].amount;
            expenses.splice(index, 1);
            renderExpenses();
            calculate();
        }

        // --- Core Algorithm ---
        function calculate() {
            const resultList = document.getElementById('result-list');
            const t = translations[currentLang];
            lastTransactions = []; // Reset shared transactions

            if (expenses.length === 0) {
                resultList.innerHTML = `<p class="text-center text-gray-400 dark:text-gray-500 text-sm py-2">è¼¸å…¥æ¶ˆè²»å¾Œæœƒè‡ªå‹•è¨ˆç®—...</p>`;
                return;
            }

            let balances = {};
            users.forEach(u => balances[u] = 0);

            expenses.forEach(e => {
                for (const [payer, amount] of Object.entries(e.payers)) {
                    balances[payer] += amount;
                }
                for (const [consumer, amount] of Object.entries(e.consumers)) {
                    balances[consumer] -= amount;
                }
            });

            let debtors = [];
            let creditors = [];

            for (const [user, amount] of Object.entries(balances)) {
                if (amount < -0.01) debtors.push({ user, amount }); 
                if (amount > 0.01) creditors.push({ user, amount });
            }

            debtors.sort((a, b) => a.amount - b.amount); 
            creditors.sort((a, b) => b.amount - a.amount); 

            let transactions = [];
            let i = 0, j = 0;

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                
                if (amount > 0.05) {
                    transactions.push({
                        from: debtor.user,
                        to: creditor.user,
                        money: amount.toFixed(2) 
                    });
                }

                debtor.amount += amount;
                creditor.amount -= amount;

                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            lastTransactions = transactions; // Store for sharing

            // Render Results
            if (transactions.length === 0) {
                 resultList.innerHTML = `
                    <div class="text-center py-4 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 rounded-lg">
                        ${t.noDebtMsg}
                    </div>`;
            } else {
                resultList.innerHTML = transactions.map(tData => `
                    <div class="flex flex-col items-center bg-white dark:bg-[#1a1a1a] p-4 rounded-lg shadow-sm border-l-4 border-indigo-500 dark:border-indigo-400 animate-pulse-once">
                        <div class="flex w-full justify-between items-center mb-1">
                             <div class="font-bold text-gray-700 dark:text-gray-200 truncate max-w-[45%] text-right">${tData.from}</div>
                             <span class="text-[10px] text-gray-400 dark:text-gray-500 uppercase tracking-wide mx-2">${t.payLabel}</span>
                             <div class="font-bold text-gray-700 dark:text-gray-200 truncate max-w-[45%] text-left">${tData.to}</div>
                        </div>
                        <div class="text-indigo-600 dark:text-indigo-400 font-bold text-xl mt-1 break-all text-center">
                            $${tData.money}
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- Share Functionality ---
        function shareResult() {
            const t = translations[currentLang];
            if (expenses.length === 0) {
                showToast(t.toastNoHistory, "error");
                return;
            }

            // Using array join to avoid mixed newline issues across different platforms
            let lines = [];
            lines.push(t.shareTitle);
            
            expenses.forEach((e) => {
                const payerNames = Object.keys(e.payers).join(' & ');
                const paidByText = Object.keys(e.payers).length > 1 ? t.sharePaidByMulti : t.sharePaidBy;
                lines.push(e.desc);
                lines.push(`$${e.amount.toFixed(2)} (${payerNames} ${paidByText})`);
                lines.push(""); // Empty line for visual separation
            });

            lines.push(t.shareResultTitle);
            if (lastTransactions.length === 0) {
                lines.push(t.shareNoDebt);
            } else {
                lastTransactions.forEach(trans => {
                    // e.g. â†’ peter ç•€ ivan: *$75.00*
                    lines.push(`${t.shareArrow} ${trans.from} ${t.shareGive} ${trans.to}: *$${trans.money}*`);
                });
            }

            const text = lines.join('\n');
            const shareData = {
                title: t.appTitle,
                text: text
            };

            // Try Native Share API first
            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => {
                        // Optional: show toast "Shared"
                    })
                    .catch((err) => {
                        // If error wasn't user cancellation (AbortError), fallback to copy
                        if (err.name !== 'AbortError') {
                             copyToClipboard(text);
                        }
                    });
            } else {
                // Fallback to Clipboard
                copyToClipboard(text);
            }
        }

        function copyToClipboard(text) {
             const t = translations[currentLang];
             if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast(t.toastCopied);
                }).catch(err => {
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const t = translations[currentLang];
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(t.toastCopied);
                } else {
                    showToast("Copy failed", "error");
                }
            } catch (err) {
                showToast("Copy failed", "error");
            }

            document.body.removeChild(textArea);
        }
        
        // Init logic to set placeholders correctly on load
        changeLanguage('hk');
    </script>
</body>
</html>
